# PACKAGES
library(dplyr)
library(ggplot2)
library(rsconnect)

#Connecting to Shinyapps.io
rsconnect::setAccountInfo(name='rjweise', token='7E21A201D313E81B4C8C7F5C5A6281E2', secret='g6SjLX8pTXYOHuJXz97BWBPho+Zsvny1UJgTS3iU')
#rsconnect::deployApp('WomenOfBiathlon')

# LOADING DATA
# The data is created with a R code file called BiathlonAPI.R
# Assuming that has run, we're bringing in the created data sources here:

Biosr <- read.csv("Bios.csv", colClasses = c("FullName"="character", "PhotoURI"="character", "FlagURI"="character"),header = TRUE)
Bios <- Biosr[,2:30]
BiosStatsSkiVr <- read.csv("BiosStatsSkiV.csv", header = TRUE)
BiosStatsSkiV <- BiosStatsSkiVr[,2:5] # removing the first column that got added by R
BiosStatsShootVr <- read.csv("BiosStatsShootV.csv", header = TRUE)
BiosStatsShootV <- BiosStatsShootVr[,2:5] # removing the first column that got added by R
BiosStatsProneVr <- read.csv("BiosStatsProneV.csv", header = TRUE)
BiosStatsProneV <- BiosStatsProneVr[,2:5] # removing the first column that got added by R
BiosStatsStandVr <- read.csv("BiosStatsStandV.csv", header = TRUE)
BiosStatsStandV <- BiosStatsStandVr[,2:5] # removing the first column that got added by R
BiosStatsShootingTtlProStaV <- read.csv("BiosStatsShootingTtlProStaV.csv", header = TRUE)
BiosStatsShootingTtlProStaV <- BiosStatsShootingTtlProStaV[,2:7]# removing the first column that got added by R
BiosStatsShootingTtlProStaV$FullName <- as.character(BiosStatsShootingTtlProStaV$FullName) # Convert FullName to character

# USER INTERFACE
ui = fluidPage(
    tags$h1("Women of Biathlon"),
    tags$h3("A tool for exploring the female biathlon athletes bios and their stats"),

    fluidRow(
    sidebarPanel(
        selectizeInput(inputId = 'var1', label='Select an athlete below:', choices = c("click to see list; type name to filter" = "", as.character(Bios$FullName)), multiple = FALSE,  selected = "Denise HERRMANN")
        , "After you select an athlete, it will show a few tables and a picture on the right"
        , br()
        , br()
        #, textOutput("address1") 
        , "Nation's flag"
        , htmlOutput("inc2")
        , htmlOutput("inc")
        ,fluidRow(
            tableOutput("table1"),
            tags$hr()
        )
    ),
    
    # This puts all the objects on the page in the main panel
    mainPanel(
        
        fluidRow(
                column(4,"Relative skiing performance"),    
                column(4,"Shooting performance")    
        ),
        fluidRow(
                column(4,plotOutput("plotski")),
                column(4,plotOutput("plotski2"))
        ),
        tags$hr(),
        fluidRow(
            column(4,"Prone shooting performance"),    
            column(4,"Standing shooting performance")    
        ),
        fluidRow(
                column(4,plotOutput("plotski3")),
                column(4,plotOutput("plotski4"))
        )
    ),
    ),
    tags$hr(),
    tags$hr(),
    
    fluidRow(
        plotOutput("plotski5")
    ),
    fluidRow()
    ,
    fluidRow(
        tags$p("All data is from the ", tags$a(href="https://biathlonresults.com/", "IBU's Biathlon Result website"))
    )
)


# SERVER SIDE
server = function(input, output, session) {
    
    # Show a table with the desired fields for the selected athlete  
    tab <- reactive({
        Bios[1:143,c(1,2,5,8)] %>%
            filter(as.character(FullName) == as.character(input$var1)) #%>% 
        #filter(NAT == input$var2) %>% 
        #filter(Age == input$var3)
    })
    
    # Get the photo url for the selected athlete  
    address <- reactive({
        Bios %>% select(2,12) %>%  
            filter(as.character(FullName) == as.character(input$var1)) %>% select(2)
    }) 
    
    # Get the flag url for the selected athlete
    flag <- reactive({
        Bios %>% select(2,13) %>%  
            filter(as.character(FullName) == input$var1) %>% select(2)
    }) 
    
    # Get the picture of the selected athlete (like "https://ibu.blob.core.windows.net/docs/athletes/BTGER21103199401.png")
    getPage <- function() {
        return(tags$iframe(src = as.character(address())
                           , style="width:100%;",  frameborder="0"
                           ,id="iframe"
                           , height = "500px"))
    }
    
    # Get the flag picture for the selected athlete (like "https://info.blob.core.windows.net/resources/bt/flags/ger.png")     
    getPage2 <- function() {
        return(tags$iframe(src = flag () 
                           , style="width:30%;",  frameborder="0"
                           ,id="iframe"
                           , height = "50px"))
    }
    
    # Get the skiing statistics data for only the selected athlete
    skierstats <- reactive({
        BiosStatsSkiV %>% 
            filter(FullName == input$var1)
    })
    # Get the shooting statistics data for only the selected athlete
    shootingstats <- reactive({
        BiosStatsShootV %>% 
            filter(FullName == input$var1)
    })
    # Get the prone shooting statistics data for only the selected athlete
    pronestats <- reactive({
        BiosStatsProneV %>% 
            filter(FullName == input$var1)
    })
    # Get the standing shooting statistics data for only the selected athlete
    standingstats <- reactive({
        BiosStatsStandV %>% 
            filter(FullName == input$var1)
    })
    # Get the three-in-one shooting statistics data for only the selected athlete
    shootingcombostats <- reactive({
        BiosStatsShootingTtlProStaV %>% 
            filter(FullName == input$var1)
    })

    # Render the table for tab    
    output$table1 <- renderTable({
        tab()
    })
    # Render the table for address     
    #output$table2 <- renderTable({
    #  address()
    #})
    # Render the table for flag   
    #output$table3 <- renderTable({
    #  flag()
    #})
    # Render the iframe for getPage (athlete picture)   
    output$inc <- renderUI({
        x <- input$var1  
        getPage()
    })
    # Render the iframe for getPage2 (athlete's nation flag)   
    output$inc2 <- renderUI({
        x <- input$var1  
        getPage2()
    })
    # Render the record for address   
    output$address1 <- renderPrint({
        address()
    })
    
    #output$chart1
    output$plotski <-renderPlot({
        ggplot(data = skierstats(), mapping = aes(x=variable ,y=value, group=FullName, size = 0.2)) +
            scale_x_discrete(limits=c("StatSkiing1617", "StatSkiing1718", "StatSkiing1819", "StatSkiing1920"))+
            geom_path(color = "#0097c9", show.legend=FALSE)+
            geom_point(show.legend=FALSE)+
            geom_hline(yintercept=0, linetype="dashed", color = "blue")+
            geom_hline(yintercept =5, color="red")+
            geom_hline(yintercept =-5, color="green")+
            theme_minimal()+
            ylim(10,-10)
    })
    
    #outputchart2
    output$plotski2 <- renderPlot({
        ggplot(data = shootingstats(), mapping = aes(x=variable ,y=value, group=FullName, size = 0.5)) +
            scale_x_discrete(limits=c("StatShooting1617", "StatShooting1718", "StatShooting1819", "StatShooting1920"))+
            geom_path(color = "#0097c9",show.legend=FALSE)+
            geom_point(show.legend=FALSE)+
            geom_hline(yintercept=0, linetype="dashed", color = "blue", labels("avg."))+
            theme_minimal()
    })
    
    #outputchart3
    output$plotski3 <- renderPlot({
        ggplot(data = pronestats(), mapping = aes(x=variable ,y=value, group=FullName, size = 1)) +
            scale_x_discrete(limits=c("StatShootingProne1617", "StatShootingProne1718", "StatShootingProne1819", "StatShootingProne1920"))+
            geom_path(color = "#0097c9",show.legend=FALSE)+
            geom_point(show.legend=FALSE)+
            geom_hline(yintercept=0, linetype="dashed", color = "blue", labels("avg."))+
            theme_minimal()
    })
    
    #outputchart4
    output$plotski4 <- renderPlot({
        ggplot(data = standingstats(), mapping = aes(x=variable ,y=value, group=FullName, size = 1)) +
            scale_x_discrete(limits=c("StatShootingStanding1617", "StatShootingStanding1718", "StatShootingStanding1819", "StatShootingStanding1920"))+
            geom_path(color = "#0097c9",show.legend=FALSE)+
            geom_point(show.legend=FALSE)+
            geom_hline(yintercept=0, linetype="dashed", color = "blue", labels("avg."))+
            theme_minimal()
    })
    
    #outputchart5
    output$plotski5 <- renderPlot({
        ggplot(data = shootingcombostats(), aes(x = as.character(season), group=FullName)) + 
            #adding lines
            geom_line(lineend="round",color="#009CD9",aes(y = ShootTTL,colour = "Total", linetype = "solid", size=1.04, alpha=0.4)) + 
            geom_line(lineend="round",color="#D8E935",aes(y = ShootPRO,colour = "Prone", linetype = "solid", size=1.005, alpha=0.4)) +
            geom_line(lineend="round",color="#A2BF15",aes(y = ShootSTA,colour = "Standing", linetype = "solid", size=1.005, alpha=0.4))+
            #adding points
            geom_point(color="#009CD9",aes(y = ShootTTL,colour = "Total", size=1.04, alpha=0.4)) + 
            geom_point(color="#D8E935",aes(y = ShootPRO,colour = "Prone", size=1, alpha=0.4)) +
            geom_point(color="#A2BF15",aes(y = ShootSTA,colour = "Standing", size=1, alpha=0.4))+
            #background them
            theme_minimal()+
            geom_text(aes(x=as.character(season), y=ShootTTL, label=ShootTTL, size=1.02))+
            geom_text(aes(x=as.character(season), y=ShootPRO, label=ShootPRO, size=1.005))+
            geom_text(aes(x=as.character(season), y=ShootSTA, label=ShootSTA, size=1.005))+
            geom_text(color="#009CD9", aes(x=as.character(season), y=ShootTTL, label=ifelse(as.character(season) == "1920", "Total",""), size=1.02, hjust = -0.25))+
            geom_text(color="#D8E935", aes(x=as.character(season), y=ShootPRO, label=ifelse(as.character(season) == "1920", "Prone",""), size=1.008, hjust = -0.25))+
            geom_text(color="#A2BF15", aes(x=as.character(season), y=ShootSTA, label=ifelse(as.character(season) == "1920", "Standing",""), size=1.008, hjust = -0.25))+
            guides(size=FALSE)+
            guides(alpha=FALSE)+
            guides(linetype=FALSE)+
            labs(x= "Season", y = "Shooting percentage")
    })
}

# SHINY MAGIC
shinyApp(ui = ui, server = server) # this launches your app
